"use strict";
var $table;
var $xhr;

function doPreRenderReq(data, type, row) {
    return '<pre class="my-hide my-pre">原报文：' + JSON.stringify(row.req) + '</pre><pre class="my-pre" ondblclick="dbclick()">' + data + '<pre>';
}

function doPreRenderRes(data, type, row) {
    return '<pre class="my-hide my-pre">原报文：' + JSON.stringify(row.res) + '</pre><pre class="my-pre" ondblclick="dbclick()">' + data + '<pre>';
}

function doPreRenderNotify(data, type, row) {
    return '<pre class="my-hide my-pre">原报文：' + JSON.stringify(row.notify) + '</pre><pre class="my-pre" ondblclick="dbclick()">' + data + '<pre>';
}

$(document).ready(function () {
    if ($("#data-table")[0]) {
        $table = $("#data-table").DataTable({
            destroy: true,
            paging: false,
            ajax: function (data, callback, settings) {
                $('#my-loading').modal('show');
                //query params
                var queryStr = $('#fullSearch').val();
                if ($xhr) {
                    $xhr.abort();
                }
                $xhr = $.ajax({
                    async: true,
                    url: './search/white?queryStr=' + queryStr,
                    type: 'get',
                    dataType: 'json',
                    success: function (rdata) {
                        data.data = rdata.data;
                        callback(data);
                        $('#my-loading').modal('hide');
                    },
                    error: function () {
                        $('#my-loading').modal('hide');
                    }
                });
            },
            columns: [
                {"data": "id.date"},
                {"data": "url"},
                {"data": "action"},
                {"data": "reqFormat"},
                {"data": "resFormat"},
                {"data": "notifyFormat"}
            ],
            columnDefs: [{
                "render": doPreRenderReq,
                "targets": 3
            }, {
                "render": doPreRenderRes,
                "targets": 4
            }, {
                "render": doPreRenderNotify,
                "targets": 5
            }],
            autoWidth: !1,
            responsive: !0,
            lengthMenu: [[50, 100, 500, 2000, -1], ["50 行", "100 行", "500 行", "2000 行", "所有"]],
            language: {
                searchPlaceholder: "               前           端          二           次           过           滤"
            },
            sDom: '<"dataTables__top"lfB>rt<"dataTables__bottom"ip><"clear">',
            buttons: [{
                extend: "excelHtml5",
                title: "Export Data"
            },
                {
                    extend: "csvHtml5",
                    title: "Export Data"
                },
                {
                    extend: "print",
                    title: "Material Admin"
                }],
            initComplete: function (a, b) {
                $(this).closest(".dataTables_wrapper").find(".dataTables__top").prepend(
                    '<div class="dataTables_buttons hidden-sm-down actions">' +
                    '<span class="actions__item " data-table-action="print">打印</span>' +
                    '<span class="actions__item " data-table-action="fullscreen">全屏</span>' +
                    '<div class="dropdown actions__item"><i data-toggle="dropdown" class="">导出</i>' +
                    '<ul class="dropdown-menu dropdown-menu-right">' +
                    '<a href="" class="dropdown-item" data-table-action="excel">Excel (.xlsx)</a>' +
                    '<a href="" class="dropdown-item" data-table-action="csv">CSV (.csv)</a>' +
                    '</ul>' +
                    '</div>' +
                    '</div>')
            }
        }),
            $(".dataTables_filter input[type=search]").focus(function () {
                $(this).closest(".dataTables_filter").addClass("dataTables_filter--toggled")
            }),
            $(".dataTables_filter input[type=search]").blur(function () {
                $(this).closest(".dataTables_filter").removeClass("dataTables_filter--toggled")
            }),
            $("body").on("click", "[data-table-action]",
                function (a) {
                    a.preventDefault();
                    var b = $(this).data("table-action");
                    if ("excel" === b && $(this).closest(".dataTables_wrapper").find(".buttons-excel").trigger("click"), "csv" === b && $(this).closest(".dataTables_wrapper").find(".buttons-csv").trigger("click"), "print" === b && $(this).closest(".dataTables_wrapper").find(".buttons-print").trigger("click"), "fullscreen" === b) {
                        var c = $(this).closest(".card");
                        c.hasClass("card--fullscreen") ? (c.removeClass("card--fullscreen"), $("body").removeClass("data-table-toggled")) : (c.addClass("card--fullscreen"), $("body").addClass("data-table-toggled"))
                    }
                })
    }
    $('#fullSearch').mouseover(function () {
        $(this).focus();
    }).focus().keydown(function (event) {
        // if (event.which == 13) {
        //     event.preventDefault();
        // }
        if (event.keyCode == 13) {
            $('#my-loading').modal('show');
            var table = $('#data-table').DataTable();
            table.ajax.reload();
            $('.navigation>li:first').click();
        }
    });

    $('.toast').toast('show');

    var table = $('#data-table').DataTable();
    table.ajax.reload();

    $(document).on('dblclick', '.my-pre', function () {
        $(this).siblings().toggleClass("my-hide");
    });

    var $navLi = $('.navigation>li');
    $navLi.click(function () {
        var idx = $navLi.index(this);
        $navLi.removeClass('navigation__active');
        $(this).addClass('navigation__active');
        $('.card').hide().eq(idx).show();
    })
});